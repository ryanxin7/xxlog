<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.60" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://vuepress-theme-hope-docs-demo.netlify.app/mysql/log/dba07.html"><meta property="og:site_name" content="Ryan's Notebook"><meta property="og:title" content="逻辑备份与恢复"><meta property="og:description" content="逻辑备份与恢复 1. 上节回顾 1.1 日志 binlog 如何开启? binlog_format=row SBR 模式参数 RBR 与 SBR 模式之间的区别： 例如要更新大于2000的数据行 ，此时需要更新1000行数据，RBR记录每一行的变化，SBR则只记录这一条命令，但是SBR有可能会记录错误的日志，如在函数 now 当前时间的命令会有错误。"><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2023-05-02T00:25:35.000Z"><meta property="article:tag" content="DBA"><meta property="article:tag" content="RDBMS"><meta property="article:published_time" content="2020-07-20T02:13:01.000Z"><meta property="article:modified_time" content="2023-05-02T00:25:35.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"逻辑备份与恢复","image":[""],"datePublished":"2020-07-20T02:13:01.000Z","dateModified":"2023-05-02T00:25:35.000Z","author":[]}</script><title>逻辑备份与恢复 | Ryan's Notebook</title><meta name="description" content="逻辑备份与恢复 1. 上节回顾 1.1 日志 binlog 如何开启? binlog_format=row SBR 模式参数 RBR 与 SBR 模式之间的区别： 例如要更新大于2000的数据行 ，此时需要更新1000行数据，RBR记录每一行的变化，SBR则只记录这一条命令，但是SBR有可能会记录错误的日志，如在函数 now 当前时间的命令会有错误。">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/assets/style-e9ac4e0d.css" as="style"><link rel="stylesheet" href="/assets/style-e9ac4e0d.css">
    <link rel="modulepreload" href="/assets/app-bbc90764.js"><link rel="modulepreload" href="/assets/framework-91fce522.js"><link rel="modulepreload" href="/assets/dba07.html-52f09c94.js"><link rel="modulepreload" href="/assets/dba07.html-61409a4d.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">跳至主要內容</a><!--]--><div class="theme-container has-toc"><!--[--><header class="navbar" id="navbar"><div class="navbar-start"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><a href="/" class="brand"><img class="logo" src="/logo.svg" alt="Ryan&#39;s Notebook"><!----><span class="site-name hide-in-pad">Ryan&#39;s Notebook</span></a><!--[--><!----><!--]--></div><div class="navbar-center"><!--[--><!----><!--]--><nav class="nav-links"><div class="nav-item hide-in-mobile"><a href="/" class="nav-link" aria-label="濼鑫的知识库"><span class="font-icon icon iconfont icon-home" style=""></span>濼鑫的知识库<!----></a></div><div class="nav-item hide-in-mobile"><a href="/category/" class="nav-link" aria-label="归档🗂️"><span class="font-icon icon iconfont icon-beaker" style=""></span>归档🗂️<!----></a></div><div class="nav-item hide-in-mobile"><a href="/article/" class="nav-link" aria-label="文章🌱"><span class="font-icon icon iconfont icon-beaker" style=""></span>文章🌱<!----></a></div><div class="nav-item hide-in-mobile"><a href="/timeline/" class="nav-link" aria-label="时间线⏰"><span class="font-icon icon iconfont icon-beaker" style=""></span>时间线⏰<!----></a></div><div class="nav-item hide-in-mobile"><a href="/about/" class="nav-link" aria-label="关于🤷"><span class="font-icon icon iconfont icon-beaker" style=""></span>关于🤷<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="小记📌"><span class="title"><!---->小记📌</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>小记</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/xj/" class="nav-link" aria-label="小记"><span class="font-icon icon iconfont icon-exercise" style=""></span>小记<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>常用工具</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="https://imageresizer.com/" rel="noopener noreferrer" target="_blank" aria-label="图片压缩" class="nav-link"><span class="font-icon icon iconfont icon-more" style=""></span>图片压缩<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></li><li class="dropdown-subitem"><a href="https://www.flaticon.com/" rel="noopener noreferrer" target="_blank" aria-label="免费图标素材" class="nav-link"><span class="font-icon icon iconfont icon-more" style=""></span>免费图标素材<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></li><li class="dropdown-subitem"><a href="https://emojipedia.org/" rel="noopener noreferrer" target="_blank" aria-label="emojipedia" class="nav-link"><span class="font-icon icon iconfont icon-more" style=""></span>emojipedia<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></li></ul></li></ul></button></div></div></nav><!--[--><!----><!--]--></div><div class="navbar-end"><!--[--><!----><!--]--><!----><div class="nav-item"><a class="repo-link" href="https://github.com/ryanxin7/xxlog" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!--[--><button class="search-pro-button" role="search" aria-label="搜索"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="placeholder">搜索</div><div class="key-hints"><kbd class="key">Ctrl</kbd><kbd class="key">K</kbd></div></button><!--]--><!--[--><!----><!--]--><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside class="sidebar" id="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><!--[--><a href="/mysql/" class="nav-link sidebar-link sidebar-page" aria-label="Mysql"><!---->Mysql<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><section class="sidebar-group"><p class="sidebar-heading active"><!----><span class="title"></span><!----></p><ul class="sidebar-links"><li><!--[--><a href="/mysql/log/dba06.html" class="nav-link sidebar-link sidebar-page" aria-label="常用日志文件类型介绍"><!---->常用日志文件类型介绍<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/mysql/log/dba05.html" class="nav-link sidebar-link sidebar-page" aria-label="存储引擎介绍与企业案例"><!---->存储引擎介绍与企业案例<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/mysql/log/dba04.html" class="nav-link sidebar-link sidebar-page" aria-label="第三章回顾 补充元数据查询部分"><!---->第三章回顾 补充元数据查询部分<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/mysql/log/dba08.html" class="nav-link sidebar-link sidebar-page" aria-label="高可用架构方案"><!---->高可用架构方案<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-current="page" href="/mysql/log/dba07.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" aria-label="逻辑备份与恢复"><!---->逻辑备份与恢复<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/mysql/log/dba07.html#_1-上节回顾" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1. 上节回顾"><!---->1. 上节回顾<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/mysql/log/dba07.html#_1-1-日志" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.1  日志"><!---->1.1  日志<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/mysql/log/dba07.html#_1-2-二进制日志清理" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.2 二进制日志清理"><!---->1.2 二进制日志清理<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/mysql/log/dba07.html#_1-2-1-自动清理" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.2.1 自动清理"><!---->1.2.1 自动清理<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/mysql/log/dba07.html#_1-2-2-手动清理" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.2.2 手动清理"><!---->1.2.2 手动清理<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/mysql/log/dba07.html#_1-3-日志如何滚动" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.3 日志如何滚动"><!---->1.3 日志如何滚动<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/mysql/log/dba07.html#_1-4-slow-log-慢语句分析" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.4 slow log 慢语句分析"><!---->1.4 slow log 慢语句分析<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/mysql/log/dba07.html#_1-5-innodb-核心参数" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.5 innodb 核心参数"><!---->1.5 innodb 核心参数<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/mysql/log/dba07.html#_2-在备份恢复中的职责" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2. 在备份恢复中的职责"><!---->2. 在备份恢复中的职责<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/mysql/log/dba07.html#_2-1-备份策略的设计" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2.1 备份策略的设计"><!---->2.1 备份策略的设计<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/mysql/log/dba07.html#_2-2-检查备份可用性" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2.2 检查备份可用性"><!---->2.2 检查备份可用性<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/mysql/log/dba07.html#_2-3-数据恢复" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2.3 数据恢复"><!---->2.3 数据恢复<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/mysql/log/dba07.html#_2-4-数据迁移" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2.4 数据迁移"><!---->2.4 数据迁移<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/mysql/log/dba07.html#_2-5-备份情况介绍" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2.5 备份情况介绍"><!---->2.5 备份情况介绍<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/mysql/log/dba07.html#_3-逻辑备份操作" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="3 . 逻辑备份操作"><!---->3 . 逻辑备份操作<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/mysql/log/dba07.html#mysqldump-参数介绍" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="mysqldump 参数介绍"><!---->mysqldump 参数介绍<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/mysql/log/dba07.html#_3-1-连接数据库参数" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="3.1  连接数据库参数"><!---->3.1  连接数据库参数<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/mysql/log/dba07.html#_3-2-基础备份参数" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="3.2 基础备份参数"><!---->3.2 基础备份参数<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/mysql/log/dba07.html#_3-3-特殊备份参数" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="3.3 特殊备份参数"><!---->3.3 特殊备份参数<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/mysql/log/dba07.html#_3-4-恢复-binlog" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="3.4 恢复 binlog"><!---->3.4 恢复 binlog<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/mysql/log/dba07.html#_4-恢复案例" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4. 恢复案例"><!---->4. 恢复案例<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/mysql/log/dba07.html#_4-1-背景环境" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4.1 背景环境"><!---->4.1 背景环境<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/mysql/log/dba07.html#_4-2-备份策略" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4.2 备份策略"><!---->4.2 备份策略<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/mysql/log/dba07.html#_4-3-故障时间点" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4.3 故障时间点"><!---->4.3 故障时间点<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/mysql/log/dba07.html#_4-4-思路" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4.4  思路"><!---->4.4  思路<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/mysql/log/dba07.html#_4-5-故障模拟演练" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4.5  故障模拟演练"><!---->4.5  故障模拟演练<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/mysql/log/dba07.html#_4-6-恢复过程" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4.6 恢复过程"><!---->4.6 恢复过程<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/mysql/log/dba07.html#_5-恢复练习" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="5.恢复练习"><!---->5.恢复练习<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/mysql/log/dba07.html#_6-扩展参数" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="6.扩展参数"><!---->6.扩展参数<!----></a><ul class="sidebar-sub-headers"></ul></li></ul><!--]--></li><li><!--[--><a href="/mysql/log/dba06-2.html" class="nav-link sidebar-link sidebar-page" aria-label="慢日志分析"><!---->慢日志分析<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/mysql/log/dba01.html" class="nav-link sidebar-link sidebar-page" aria-label="数据库版本介绍与安装"><!---->数据库版本介绍与安装<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/mysql/log/dba04-2.html" class="nav-link sidebar-link sidebar-page" aria-label="索引原理介绍创建与执行计划分析"><!---->索引原理介绍创建与执行计划分析<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/mysql/log/dba02.html" class="nav-link sidebar-link sidebar-page" aria-label="体系结构及管理"><!---->体系结构及管理<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/mysql/log/dba07-1.html" class="nav-link sidebar-link sidebar-page" aria-label="物理备份与恢复 XBK"><!---->物理备份与恢复 XBK<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/mysql/log/dba08-1.html" class="nav-link sidebar-link sidebar-page" aria-label="主从复制高级进阶"><!---->主从复制高级进阶<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/mysql/log/dba03-1.html" class="nav-link sidebar-link sidebar-page" aria-label="DDL 语句的应用"><!---->DDL 语句的应用<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/mysql/log/dba03-2.html" class="nav-link sidebar-link sidebar-page" aria-label="DQL 查询语句与元数据"><!---->DQL 查询语句与元数据<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/mysql/log/dba06-1.html" class="nav-link sidebar-link sidebar-page" aria-label="GTID 记录模式管理"><!---->GTID 记录模式管理<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/mysql/log/dba05-1.html" class="nav-link sidebar-link sidebar-page" aria-label="InnoDB 存储引擎物理存储结构"><!---->InnoDB 存储引擎物理存储结构<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/mysql/log/dba05-3.html" class="nav-link sidebar-link sidebar-page" aria-label="InnoDB 核心参数介绍"><!---->InnoDB 核心参数介绍<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/mysql/log/dba05-2.html" class="nav-link sidebar-link sidebar-page" aria-label="InnoDB 核心特性"><!---->InnoDB 核心特性<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/mysql/log/dba09.html" class="nav-link sidebar-link sidebar-page" aria-label="MHA 高可用部署"><!---->MHA 高可用部署<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/mysql/log/dba03.html" class="nav-link sidebar-link sidebar-page" aria-label="SQL 基本概念引入"><!---->SQL 基本概念引入<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->逻辑备份与恢复</h1><div class="page-info"><span class="page-author-info" aria-label="作者🖊" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="http://ryanxin.live" target="_blank" rel="noopener noreferrer">Ryan</a></span><span property="author" content="Ryan"></span></span><!----><span class="page-date-info" aria-label="写作日期📅" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2020-07-20T02:13:01.000Z"></span><!----><span class="page-reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 9 分钟</span><meta property="timeRequired" content="PT9M"></span><span class="page-category-info" aria-label="分类🌈" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><span class="page-category-item category2 clickable" role="navigation">DBA</span><meta property="articleSection" content="DBA"></span><span class="page-tag-info" aria-label="标签🏷" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><span class="page-tag-item tag2 clickable" role="navigation">DBA</span><span class="page-tag-item tag2 clickable" role="navigation">RDBMS</span><meta property="keywords" content="DBA,RDBMS"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">此页内容<button class="print-button" title="print"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/mysql/log/dba07.html#_1-上节回顾" class="router-link-active router-link-exact-active toc-link level2">1. 上节回顾</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/mysql/log/dba07.html#_1-1-日志" class="router-link-active router-link-exact-active toc-link level3">1.1  日志</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/mysql/log/dba07.html#_1-2-二进制日志清理" class="router-link-active router-link-exact-active toc-link level3">1.2 二进制日志清理</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/mysql/log/dba07.html#_1-2-1-自动清理" class="router-link-active router-link-exact-active toc-link level3">1.2.1 自动清理</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/mysql/log/dba07.html#_1-2-2-手动清理" class="router-link-active router-link-exact-active toc-link level3">1.2.2 手动清理</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/mysql/log/dba07.html#_1-3-日志如何滚动" class="router-link-active router-link-exact-active toc-link level3">1.3 日志如何滚动</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/mysql/log/dba07.html#_1-4-slow-log-慢语句分析" class="router-link-active router-link-exact-active toc-link level3">1.4 slow log 慢语句分析</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/mysql/log/dba07.html#_1-5-innodb-核心参数" class="router-link-active router-link-exact-active toc-link level3">1.5 innodb 核心参数</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/mysql/log/dba07.html#_2-在备份恢复中的职责" class="router-link-active router-link-exact-active toc-link level2">2. 在备份恢复中的职责</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/mysql/log/dba07.html#_2-1-备份策略的设计" class="router-link-active router-link-exact-active toc-link level3">2.1 备份策略的设计</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/mysql/log/dba07.html#_2-2-检查备份可用性" class="router-link-active router-link-exact-active toc-link level3">2.2 检查备份可用性</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/mysql/log/dba07.html#_2-3-数据恢复" class="router-link-active router-link-exact-active toc-link level3">2.3 数据恢复</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/mysql/log/dba07.html#_2-4-数据迁移" class="router-link-active router-link-exact-active toc-link level3">2.4 数据迁移</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/mysql/log/dba07.html#_2-5-备份情况介绍" class="router-link-active router-link-exact-active toc-link level3">2.5 备份情况介绍</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/mysql/log/dba07.html#_3-逻辑备份操作" class="router-link-active router-link-exact-active toc-link level2">3 . 逻辑备份操作</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/mysql/log/dba07.html#mysqldump-参数介绍" class="router-link-active router-link-exact-active toc-link level3">mysqldump 参数介绍</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/mysql/log/dba07.html#_3-1-连接数据库参数" class="router-link-active router-link-exact-active toc-link level3">3.1  连接数据库参数</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/mysql/log/dba07.html#_3-2-基础备份参数" class="router-link-active router-link-exact-active toc-link level3">3.2 基础备份参数</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/mysql/log/dba07.html#_3-3-特殊备份参数" class="router-link-active router-link-exact-active toc-link level3">3.3 特殊备份参数</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/mysql/log/dba07.html#_3-4-恢复-binlog" class="router-link-active router-link-exact-active toc-link level3">3.4 恢复 binlog</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/mysql/log/dba07.html#_4-恢复案例" class="router-link-active router-link-exact-active toc-link level2">4. 恢复案例</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/mysql/log/dba07.html#_4-1-背景环境" class="router-link-active router-link-exact-active toc-link level3">4.1 背景环境</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/mysql/log/dba07.html#_4-2-备份策略" class="router-link-active router-link-exact-active toc-link level3">4.2 备份策略</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/mysql/log/dba07.html#_4-3-故障时间点" class="router-link-active router-link-exact-active toc-link level3">4.3 故障时间点</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/mysql/log/dba07.html#_4-4-思路" class="router-link-active router-link-exact-active toc-link level3">4.4  思路</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/mysql/log/dba07.html#_4-5-故障模拟演练" class="router-link-active router-link-exact-active toc-link level3">4.5  故障模拟演练</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/mysql/log/dba07.html#_4-6-恢复过程" class="router-link-active router-link-exact-active toc-link level3">4.6 恢复过程</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/mysql/log/dba07.html#_5-恢复练习" class="router-link-active router-link-exact-active toc-link level2">5.恢复练习</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/mysql/log/dba07.html#_6-扩展参数" class="router-link-active router-link-exact-active toc-link level2">6.扩展参数</a></li><!----><!--]--></ul></div><!--[--><!----><!--]--></aside></div><!----><div class="theme-hope-content"><h1 id="逻辑备份与恢复" tabindex="-1"><a class="header-anchor" href="#逻辑备份与恢复" aria-hidden="true">#</a> 逻辑备份与恢复</h1><h2 id="_1-上节回顾" tabindex="-1"><a class="header-anchor" href="#_1-上节回顾" aria-hidden="true">#</a> 1. 上节回顾</h2><br><h3 id="_1-1-日志" tabindex="-1"><a class="header-anchor" href="#_1-1-日志" aria-hidden="true">#</a> 1.1 日志</h3><p><strong>binlog</strong> 如何开启?</p><p><code>binlog_format=row</code> SBR 模式参数</p><br><p><strong>RBR 与 SBR 模式之间的区别</strong>：</p><p>例如要更新大于2000的数据行 ，此时需要更新1000行数据，RBR记录每一行的变化，SBR则只记录这一条命令，但是SBR有可能会记录错误的日志，如在函数 now 当前时间的命令会有错误。</p><br><br><p><strong>双一标准的其中一个</strong>：</p><p><code>sync_binlog=1</code> 每次事务提交都立即刷写binlog到磁盘</p><br><p><strong>双一标准的另一个：</strong></p><p><code>innodb_flush_log_at_trx_commit=1</code> 在事务提交时刷写 redo 到磁盘策略</p><p><strong>查看日志：</strong></p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">show</span> master <span class="token keyword">status</span> <span class="token punctuation">;</span>
<span class="token keyword">show</span> binlog events <span class="token operator">in</span> <span class="token string">&#39;日志名称&#39;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>非GTID 截取日志</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>mysqlbinlog --start-position  --stop-position  <span class="token comment">#截取日志</span>
--base64-output<span class="token operator">=</span>decode-rows  <span class="token parameter variable">-vvv</span>  <span class="token comment">#(--help可以查到)   翻译成人话</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div> <br><br><p><strong>GTID</strong> 5.6版本出现 <strong>5.7版本</strong> 推荐使用</p><br><p><strong>GTID的开启和配置</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">vim</span> /etc/my.cnf
gtid-mode<span class="token operator">=</span>on
enforce-gtid-consistency<span class="token operator">=</span>true <span class="token comment">#强制gtid一致性</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div> <br><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code>不知道参数的情况下：
mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">&#39;%gtid%&#39;</span><span class="token punctuation">;</span> <span class="token comment">--查看GTIT有有关的参数</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div> <br><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># mysqlbinlog --help |grep gtid 帮助</span>
 --skip-gtids  跳过GTIP检查 导出日志时不记录日志  
 --include-gtids<span class="token operator">=</span><span class="token string">&#39;&#39;</span>   想截取哪一段日志
 --exclude-gtids<span class="token operator">=</span><span class="token string">&#39;&#39;</span>  想排除哪一段日志
 
<span class="token builtin class-name">set</span> <span class="token assign-left variable">sql_log_bin</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>    临时关闭当前窗口的二进制日志
<span class="token builtin class-name">source</span> <span class="token punctuation">..</span>             恢复命令
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div> <br><p><strong>幂等性</strong>：在数据恢复时检查幂等性功能做过的事情就不会再做了</p><br><br><h3 id="_1-2-二进制日志清理" tabindex="-1"><a class="header-anchor" href="#_1-2-二进制日志清理" aria-hidden="true">#</a> 1.2 二进制日志清理</h3><br><h3 id="_1-2-1-自动清理" tabindex="-1"><a class="header-anchor" href="#_1-2-1-自动清理" aria-hidden="true">#</a> 1.2.1 自动清理</h3><p><strong>设置的依据</strong>: 至少1轮全备周期长度的过期时间. 7天一个全备 两轮加一天</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>show variables like <span class="token string">&#39;%expire%&#39;</span>；
<span class="token assign-left variable">expire_logs_days</span><span class="token operator">=</span><span class="token number">15</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://xin997.oss-cn-beijing.aliyuncs.com/xinblogs/webimg-DBA/Section7-1.png" alt="日志清理1" tabindex="0" loading="lazy"><figcaption>日志清理1</figcaption></figure><br><br><h3 id="_1-2-2-手动清理" tabindex="-1"><a class="header-anchor" href="#_1-2-2-手动清理" aria-hidden="true">#</a> 1.2.2 手动清理</h3><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> help <span class="token keyword">purge</span> <span class="token comment">--手工</span>
<span class="token keyword">PURGE</span> <span class="token keyword">BINARY</span> LOGS <span class="token keyword">TO</span> <span class="token string">&#39;mysql-bin.000032&#39;</span><span class="token punctuation">;</span> <span class="token comment">--删除到那个日志为止</span>
<span class="token keyword">PURGE</span> <span class="token keyword">BINARY</span> LOGS BEFORE <span class="token string">&#39;2008-04-02 22:46:26&#39;</span><span class="token punctuation">;</span> <span class="token comment">--按照时间删除</span>
mysql<span class="token operator">&gt;</span> reset master <span class="token punctuation">;</span> <span class="token comment">--全清了 主从主库绝对不能删</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://xin997.oss-cn-beijing.aliyuncs.com/xinblogs/webimg-DBA/Section7-1-1.png" alt="日志清理2" tabindex="0" loading="lazy"><figcaption>日志清理2</figcaption></figure><br><br><h3 id="_1-3-日志如何滚动" tabindex="-1"><a class="header-anchor" href="#_1-3-日志如何滚动" aria-hidden="true">#</a> 1.3 <strong>日志如何滚动</strong></h3><br><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code> flush logs<span class="token punctuation">;</span> <span class="token comment">--重新的一个文件开始记录日志</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>数据库重启</strong></p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">&#39;%max%&#39;</span>
max_binlog_size<span class="token operator">=</span><span class="token number">1073741824</span>  <span class="token comment">--二进制文件的最大大小</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div> <br><br><h3 id="_1-4-slow-log-慢语句分析" tabindex="-1"><a class="header-anchor" href="#_1-4-slow-log-慢语句分析" aria-hidden="true">#</a> 1.4 slow log 慢语句分析</h3><br><p>慢语句开关</p><figure><img src="https://xin997.oss-cn-beijing.aliyuncs.com/xinblogs/webimg-DBA/Section7-1-2.png" alt="慢语句开关" tabindex="0" loading="lazy"><figcaption>慢语句开关</figcaption></figure><br><p>文件位置</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">&#39;slow_query_log%&#39;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://xin997.oss-cn-beijing.aliyuncs.com/xinblogs/webimg-DBA/Section7-1-3.png" alt="慢语句位置" tabindex="0" loading="lazy"><figcaption>慢语句位置</figcaption></figure><br><figure><img src="https://xin997.oss-cn-beijing.aliyuncs.com/xinblogs/webimg-DBA/Section7-1-4.png" alt="慢语句位置" tabindex="0" loading="lazy"><figcaption>慢语句位置</figcaption></figure><figure><img src="https://xin997.oss-cn-beijing.aliyuncs.com/xinblogs/webimg-DBA/Section7-1-5.png" alt="慢语句位置" tabindex="0" loading="lazy"><figcaption>慢语句位置</figcaption></figure><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">&#39;long%&#39;</span><span class="token punctuation">;</span> <span class="token comment">--时间阈值超过这个时间就算慢语句</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">&#39;%using_indexes%&#39;</span><span class="token punctuation">;</span> <span class="token comment">--是否记录不走索引的语句</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code>mysqldumpslow <span class="token operator">-</span>s c <span class="token operator">-</span>t <span class="token number">10</span> <span class="token operator">/</span>xxxxx <span class="token comment">--分析慢语句</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div> <br><br><h3 id="_1-5-innodb-核心参数" tabindex="-1"><a class="header-anchor" href="#_1-5-innodb-核心参数" aria-hidden="true">#</a> 1.5 innodb 核心参数</h3><p><strong>双一参数</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token assign-left variable">innodb_flush_log_at_trx_commit</span><span class="token operator">=</span><span class="token number">1</span>  <span class="token comment">#最安全模式 为1时每次提交事务都刷新到磁盘</span>
<span class="token assign-left variable">innodb_flush_method</span><span class="token operator">=</span>o_direct      <span class="token comment">#数据刷新到磁盘绕过系统缓存由于不走缓存性能较慢 直通模式</span>
<span class="token assign-left variable">innodb_flush_log_at_trx_commit</span><span class="token operator">=</span><span class="token number">0</span>  <span class="token comment">#最高性能模式</span>
<span class="token assign-left variable">innodb_flush_method</span><span class="token operator">=</span>fsync         <span class="token comment">#为0 时事务每秒刷写到磁盘不管提交没提交</span>
                                  <span class="token comment">#但是每秒发生无数事务断电可能导致事务丢失。 </span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div> <br><br><h2 id="_2-在备份恢复中的职责" tabindex="-1"><a class="header-anchor" href="#_2-在备份恢复中的职责" aria-hidden="true">#</a> 2. 在备份恢复中的职责</h2><br><h3 id="_2-1-备份策略的设计" tabindex="-1"><a class="header-anchor" href="#_2-1-备份策略的设计" aria-hidden="true">#</a> 2.1 备份策略的设计</h3><p>通过三个方面设计</p><p><strong>(1) 备份周期:</strong></p><p>根据数据量设计备份周期</p><p><strong>例如</strong>：</p><p>60G数据大小所需备份时间大约为30分钟尽量每天备份一次</p><p>而到达 9T 数据量就应该是按照每周备份一次了。</p><br><p><strong>(2)备份工具</strong>:</p><ul><li><p>mysqldump (MDP) 用于每天</p></li><li><p>XBK (PBK) percona Xtrabackup 用于每周</p></li><li><p>MEB(MySQL Enterprise BACKUP MEB官方企业版工具)</p></li><li><p>MySQL binlog 二进制日志截取恢复</p><br></li></ul><p><strong>(3)备份方式</strong>:</p><p><strong>逻辑备份</strong>:</p><ul><li>全备 mysqldump 整个备份</li><li>增量 binlog (flush logs 滚动日志拷贝最后一个文件之前的日志 ,cp靠走) 增量备份</li></ul><br><p><strong>物理备份</strong>:</p><ul><li>全备 : XBK</li><li>增量 : XBK</li></ul><br><h3 id="_2-2-检查备份可用性" tabindex="-1"><a class="header-anchor" href="#_2-2-检查备份可用性" aria-hidden="true">#</a> 2.2 检查备份可用性</h3><br><p>一般晚上11点执行</p><p><strong>检查流程</strong>：</p><ul><li><p>crontab -l</p></li><li><p>备份脚本</p></li><li><p>备份路径</p></li><li><p>看备份日志,检查备份文件(大小,内容)</p></li><li><p>定期的恢复演练</p><br></li></ul><br><h3 id="_2-3-数据恢复" tabindex="-1"><a class="header-anchor" href="#_2-3-数据恢复" aria-hidden="true">#</a> 2.3 数据恢复</h3><p>只要备份和日志是完整的,恢复到故障之前的时间点(快速)</p><br><br><h3 id="_2-4-数据迁移" tabindex="-1"><a class="header-anchor" href="#_2-4-数据迁移" aria-hidden="true">#</a> 2.4 数据迁移</h3><p><strong>操作系统不同的迁移</strong></p><ul><li><p>mysql 同平台迁移</p></li><li><p>其他操作系统数据库软件 迁移到 mysql 异构平台</p></li><li><p>mysql 迁移到 其他操作系统数据库软件</p><br></li></ul><br><h3 id="_2-5-备份情况介绍" tabindex="-1"><a class="header-anchor" href="#_2-5-备份情况介绍" aria-hidden="true">#</a> 2.5 备份情况介绍</h3><br><ul><li>热备 : 对于业务影响最小 InnoDB</li><li>温备 : 长时间锁表备份 MyISAM</li><li>冷备 : 业务关闭情况下备份</li></ul><br><h2 id="_3-逻辑备份操作" tabindex="-1"><a class="header-anchor" href="#_3-逻辑备份操作" aria-hidden="true">#</a> 3 . 逻辑备份操作</h2><h3 id="mysqldump-参数介绍" tabindex="-1"><a class="header-anchor" href="#mysqldump-参数介绍" aria-hidden="true">#</a> mysqldump 参数介绍</h3><h3 id="_3-1-连接数据库参数" tabindex="-1"><a class="header-anchor" href="#_3-1-连接数据库参数" aria-hidden="true">#</a> 3.1 <strong>连接数据库参数</strong></h3><br><ul><li>-u 指定用户登录</li><li>-p 账户密码</li><li>-S 使用Soket文件登录</li><li>-h 登录网段</li><li>P 指定端口</li></ul><br><h3 id="_3-2-基础备份参数" tabindex="-1"><a class="header-anchor" href="#_3-2-基础备份参数" aria-hidden="true">#</a> 3.2 基础备份参数</h3><p><strong>-A</strong> <strong>全备</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>mysqldump <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-p123</span> <span class="token parameter variable">-A</span> <span class="token operator">&gt;</span>/backup/full.sql
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div> <br><p>-<strong>B</strong> <strong>单库</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>mysqldump <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-p123</span> <span class="token parameter variable">-B</span> world oldguo wordpress <span class="token operator">&gt;</span>/backup/db.sql
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div> <br><p><strong>分库分表备份</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>mysqldump <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-p123</span> world city country <span class="token operator">&gt;</span> /backup/tab.sql
<span class="token comment"># 第一个是库名 其他都是表名</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div> <br><br><h3 id="_3-3-特殊备份参数" tabindex="-1"><a class="header-anchor" href="#_3-3-特殊备份参数" aria-hidden="true">#</a> 3.3 特殊备份参数</h3><br><ul><li><p><code>-R</code> 存储过程和函数 类型与shell脚本</p></li><li><p><code>-E</code> 事件 类似Linux中计划任务</p></li><li><p><code>--triggers</code> 触发器</p></li><li><p><code>--master-data=2</code> 自动记录日志起点</p><br></li></ul><p><strong>案例模拟</strong>：</p><p>备份计划每天全备，大约60G数据。有一次周三下午数据库损坏。</p><br><p><strong>恢复思路</strong>：</p><p><strong>1.首先找到周二的全备恢复</strong></p><p><strong>2.截取全备到损坏之前的 binlog</strong></p><p><strong>找起点问题</strong>：</p><p><code>--master-data=2</code> 参数会自动把全备结束时二进制日志起点记下来但是他会自动锁表</p><p><strong>终点：</strong></p><p>查询二进制文件最后的位置</p><br><br><h3 id="_3-4-恢复-binlog" tabindex="-1"><a class="header-anchor" href="#_3-4-恢复-binlog" aria-hidden="true">#</a> 3.4 恢复 binlog</h3><br><p>(1) 记录备份时刻的binlog信息</p><p>(2) 自动锁表</p><p>不加<code>--single-transaction</code> ,全局锁表温备份，长时间锁表备份。</p><p>加了<code>--single-transaction</code>,对于InnoDB存储引擎的表不锁表备份，(快照备份)但是其他引擎锁表。</p><p><code>--single-transaction</code> 对于InnoDB的表,进行一致性快照备份,不锁表. 备份的是快照的数据</p><br><br><h2 id="_4-恢复案例" tabindex="-1"><a class="header-anchor" href="#_4-恢复案例" aria-hidden="true">#</a> 4. 恢复案例</h2><br><h3 id="_4-1-背景环境" tabindex="-1"><a class="header-anchor" href="#_4-1-背景环境" aria-hidden="true">#</a> 4.1 背景环境</h3><p>正在运行的网站系统，mysql-5.7.20 数据库，数据量50G，日业务增量1-5M。</p><br><h3 id="_4-2-备份策略" tabindex="-1"><a class="header-anchor" href="#_4-2-备份策略" aria-hidden="true">#</a> 4.2 备份策略</h3><p>每天23:00点，计划任务调用mysqldump执行全备脚本</p><br><h3 id="_4-3-故障时间点" tabindex="-1"><a class="header-anchor" href="#_4-3-故障时间点" aria-hidden="true">#</a> 4.3 故障时间点</h3><p><strong>年底故障演练</strong>: 模拟周三上午10点误删除数据库.</p><br><h3 id="_4-4-思路" tabindex="-1"><a class="header-anchor" href="#_4-4-思路" aria-hidden="true">#</a> 4.4 思路</h3><br><ol><li>停业务，挂维护页,避免数据的二次伤害</li><li>找一个临时库，恢复周二 23：00 点的全备</li><li>截取周二23：00 到 周三10点误删除之间的 binlog，恢复到临时库</li><li>测试可用性和完整性</li><li><strong>方法一</strong> 直接使用临时库顶替原生产库，前端应用割接到新库</li><li><strong>方法二</strong> 将误删除的表导出，导入到原生产库</li><li>开启业务</li><li>经过20分钟的处理，最终业务恢复正常</li></ol><br><h3 id="_4-5-故障模拟演练" tabindex="-1"><a class="header-anchor" href="#_4-5-故障模拟演练" aria-hidden="true">#</a> 4.5 故障模拟演练</h3><br><h4 id="_4-5-1-准备数据" tabindex="-1"><a class="header-anchor" href="#_4-5-1-准备数据" aria-hidden="true">#</a> 4.5.1 准备数据</h4><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">database</span> <span class="token keyword">backup</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token keyword">backup</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> t1 <span class="token punctuation">(</span>id <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> t1 <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">commit</span><span class="token punctuation">;</span>
rm <span class="token operator">-</span>rf <span class="token operator">/</span><span class="token keyword">backup</span><span class="token operator">/</span><span class="token operator">*</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-5-2-准备周二-23-00点的全备" tabindex="-1"><a class="header-anchor" href="#_4-5-2-准备周二-23-00点的全备" aria-hidden="true">#</a> 4.5.2 准备周二 23：00点的全备</h4><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code>mysqldump <span class="token operator">-</span>uroot <span class="token operator">-</span>p123 <span class="token operator">-</span>A <span class="token operator">-</span>R <span class="token comment">--triggers --set-gtid-purged=OFF --master-data=2 --single-transaction|gzip &gt; /backup/full_$(date +%F).sql.gz</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><strong>检查备份可用性</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> /backup/ ll*
<span class="token comment">#注意查看备份文件大小和时间点必要时打开文件查看是否备份正确</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://xin997.oss-cn-beijing.aliyuncs.com/xinblogs/webimg-DBA/Section7-1-7.png" alt="检查备份完整性" tabindex="0" loading="lazy"><figcaption>检查备份完整性</figcaption></figure><br><h4 id="_4-5-3-模拟周二-23-00到周三-10点之间数据变化" tabindex="-1"><a class="header-anchor" href="#_4-5-3-模拟周二-23-00到周三-10点之间数据变化" aria-hidden="true">#</a> 4.5.3 模拟周二 23：00到周三 10点之间数据变化</h4><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">use</span> <span class="token keyword">backup</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> t1 <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">22</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">33</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">commit</span><span class="token punctuation">;</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> t2 <span class="token punctuation">(</span>id <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> t2 <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">22</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">33</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">commit</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-5-4-模拟故障-删除表-只是模拟-不代表生产操作" tabindex="-1"><a class="header-anchor" href="#_4-5-4-模拟故障-删除表-只是模拟-不代表生产操作" aria-hidden="true">#</a> 4.5.4 模拟故障,删除表(只是模拟，不代表生产操作)</h4><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">drop</span> <span class="token keyword">database</span> <span class="token keyword">backup</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div> <br><br><h3 id="_4-6-恢复过程" tabindex="-1"><a class="header-anchor" href="#_4-6-恢复过程" aria-hidden="true">#</a> 4.6 恢复过程</h3><h4 id="_4-6-1-准备临时数据库-多实例3307" tabindex="-1"><a class="header-anchor" href="#_4-6-1-准备临时数据库-多实例3307" aria-hidden="true">#</a> 4.6.1 准备临时数据库（多实例3307）</h4><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code>systemctl <span class="token keyword">start</span> mysqld3307
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="_4-6-2-准备备份" tabindex="-1"><a class="header-anchor" href="#_4-6-2-准备备份" aria-hidden="true">#</a> 4.6.2 准备备份</h4><p>（1）准备全备：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> /backup
gunzip full_2018-10-14.sql.gz 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>（2）截取二进制日志</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code> 
<span class="token comment">-- CHANGE MASTER TO MASTER_LOG_FILE=&#39;mysql-bin.000002&#39;, MASTER_LOG_POS=753;</span>
起点 <span class="token number">753</span>
<span class="token keyword">show</span> master <span class="token keyword">status</span><span class="token punctuation">;</span> <span class="token comment">--查看日志 </span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://xin997.oss-cn-beijing.aliyuncs.com/xinblogs/webimg-DBA/Section7-1-8.png" alt="查找日志起点" tabindex="0" loading="lazy"><figcaption>查找日志起点</figcaption></figure><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token comment">#找终点 </span>

<span class="token keyword">show</span> binlog event <span class="token operator">in</span> <span class="token string">&quot;mysql-bin.000002&quot;</span> 
 
<span class="token comment">#找到终点为：1519 </span>
 
<span class="token comment">#截取日志</span>
mysqlbinlog <span class="token comment">--skip-gtids  --start-position=753 --stop-position=1519 /data/binlog/mysql-bin.000002 &gt;/backup/bin.sql</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-6-3-恢复备份到临时库" tabindex="-1"><a class="header-anchor" href="#_4-6-3-恢复备份到临时库" aria-hidden="true">#</a> 4.6.3 恢复备份到临时库</h4><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code>mysql <span class="token operator">-</span>S <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span><span class="token number">3307</span><span class="token operator">/</span>mysql<span class="token punctuation">.</span>sock
<span class="token keyword">set</span> sql_log_bin<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">--关闭二进制日志</span>
source <span class="token operator">/</span><span class="token keyword">backup</span><span class="token operator">/</span>full_2019<span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">15.</span><span class="token keyword">sql</span>
source <span class="token operator">/</span><span class="token keyword">backup</span><span class="token operator">/</span>bin<span class="token punctuation">.</span><span class="token keyword">sql</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_4-6-4-将故障表导出并恢复到生产" tabindex="-1"><a class="header-anchor" href="#_4-6-4-将故障表导出并恢复到生产" aria-hidden="true">#</a> 4.6.4 将故障表导出并恢复到生产</h4><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code>mysqldump  <span class="token operator">-</span>S <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span><span class="token number">3307</span><span class="token operator">/</span>mysql<span class="token punctuation">.</span>sock <span class="token operator">-</span>B <span class="token keyword">backup</span> <span class="token operator">&gt;</span><span class="token operator">/</span><span class="token keyword">backup</span><span class="token operator">/</span>bak<span class="token punctuation">.</span><span class="token keyword">sql</span>
mysql <span class="token operator">-</span>uroot <span class="token operator">-</span>p123 
<span class="token keyword">set</span> sql_log_bin<span class="token operator">=</span><span class="token number">0</span>
source <span class="token operator">/</span><span class="token keyword">backup</span><span class="token operator">/</span>bak<span class="token punctuation">.</span><span class="token keyword">sql</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div> <br><br><h2 id="_5-恢复练习" tabindex="-1"><a class="header-anchor" href="#_5-恢复练习" aria-hidden="true">#</a> 5.恢复练习</h2><h4 id="_5-1-创建一个数据库-test001" tabindex="-1"><a class="header-anchor" href="#_5-1-创建一个数据库-test001" aria-hidden="true">#</a> 5.1 创建一个数据库 test001</h4><p><strong>检查日志是否开启</strong> ： <code>select @@sql_log_bin;</code></p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">database</span> test001 <span class="token keyword">charset</span> utf8mb4<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="_5-2-在test001下创建一张表t1" tabindex="-1"><a class="header-anchor" href="#_5-2-在test001下创建一张表t1" aria-hidden="true">#</a> 5.2 在test001下创建一张表t1</h4><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">use</span> test001<span class="token punctuation">;</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> t1 <span class="token punctuation">(</span>id <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-3-插入5行任意数据" tabindex="-1"><a class="header-anchor" href="#_5-3-插入5行任意数据" aria-hidden="true">#</a> 5.3 插入5行任意数据</h4><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code> <span class="token keyword">insert</span> <span class="token keyword">into</span> ti <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="_5-4-进行全备" tabindex="-1"><a class="header-anchor" href="#_5-4-进行全备" aria-hidden="true">#</a> 5.4 进行全备</h4><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token builtin class-name">cd</span> /backup/ 
mysqldump <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-p123</span> <span class="token parameter variable">-A</span> --master-data<span class="token operator">=</span><span class="token number">2</span> --single-transaction <span class="token parameter variable">-R</span> <span class="token parameter variable">-E</span> <span class="token parameter variable">--triggers</span> <span class="token operator">&gt;</span> /backup/full.sql
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-5-检查备份完整性" tabindex="-1"><a class="header-anchor" href="#_5-5-检查备份完整性" aria-hidden="true">#</a> 5.5 检查备份完整性</h4><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">vim</span> full.sql  
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><figure><img src="https://xin997.oss-cn-beijing.aliyuncs.com/xinblogs/webimg-DBA/Section7-1-9.png" alt="查看日志完整性" tabindex="0" loading="lazy"><figcaption>查看日志完整性</figcaption></figure><h4 id="_5-6-插入两行数据-任意修改3行数据-删除1行数据" tabindex="-1"><a class="header-anchor" href="#_5-6-插入两行数据-任意修改3行数据-删除1行数据" aria-hidden="true">#</a> 5.6 插入两行数据，任意修改3行数据，删除1行数据</h4><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">insert</span> <span class="token keyword">into</span> t1 <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">commit</span><span class="token punctuation">;</span>
<span class="token keyword">update</span> t1 <span class="token keyword">set</span> id<span class="token operator">=</span><span class="token number">10</span> <span class="token keyword">where</span> id <span class="token operator">&gt;</span> <span class="token number">5</span>
<span class="token keyword">commit</span><span class="token punctuation">;</span>
<span class="token keyword">delete</span> <span class="token keyword">from</span> t1 <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">;</span>
<span class="token keyword">commit</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-7-删除所有数据" tabindex="-1"><a class="header-anchor" href="#_5-7-删除所有数据" aria-hidden="true">#</a> 5.7 删除所有数据</h4><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">delete</span> <span class="token keyword">from</span> t1<span class="token punctuation">;</span>
<span class="token keyword">commit</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_5-8-再t1中又插入5行新数据-修改3行数据" tabindex="-1"><a class="header-anchor" href="#_5-8-再t1中又插入5行新数据-修改3行数据" aria-hidden="true">#</a> 5.8 再t1中又插入5行新数据，修改3行数据</h4><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">insert</span> <span class="token keyword">into</span> t1 <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">commit</span><span class="token punctuation">;</span>
<span class="token keyword">update</span> t1 <span class="token keyword">set</span> id<span class="token operator">=</span><span class="token number">10</span> <span class="token keyword">where</span> id<span class="token operator">&gt;</span><span class="token number">2</span><span class="token punctuation">;</span>
<span class="token keyword">commit</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>需求</strong>：跳过第六步恢复表数据，（第六步为错误插入数据 需要排除）</p><p><strong>确认</strong>：1-5 步操作 是日志 12 -17 号 跳过第六步是15号</p><figure><img src="https://xin997.oss-cn-beijing.aliyuncs.com/xinblogs/webimg-DBA/Section7-1-10.png" alt="跳过第六步恢复表数据" tabindex="0" loading="lazy"><figcaption>跳过第六步恢复表数据</figcaption></figure><h4 id="_5-9-按照需求恢复数据" tabindex="-1"><a class="header-anchor" href="#_5-9-按照需求恢复数据" aria-hidden="true">#</a> 5.9 按照需求恢复数据</h4><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code> <span class="token keyword">set</span> sql_log_bin<span class="token operator">=</span><span class="token number">0</span>  <span class="token comment">--关闭日志</span>
 source <span class="token operator">/</span><span class="token keyword">backup</span><span class="token operator">/</span><span class="token keyword">full</span><span class="token punctuation">.</span><span class="token keyword">sql</span> <span class="token comment">--恢复全备</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_6-扩展参数" tabindex="-1"><a class="header-anchor" href="#_6-扩展参数" aria-hidden="true">#</a> 6.扩展参数</h2><p>在构建主从时,使用 AUTO/ON</p><p><code>--set-gtid-purged=AUTO/ON</code></p><p>仅是做普通的本机备份恢复时,可以添加</p><p><code>--set-gtid-purged=OFF</code></p><p><code>SET @@GLOBAL.GTID_PURGED=&#39;aa648280-a6a6-11e9-949f-000c294a1b3b:1-11&#39;;</code></p><p><code>--max_allowed_packet=128M</code> 控制的是备份时传输数据包的大小.</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>mysqldump <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-p123</span> <span class="token parameter variable">-A</span> <span class="token parameter variable">-R</span> <span class="token parameter variable">--max_allowed_packet</span><span class="token operator">=</span>128M <span class="token parameter variable">--triggers</span> --set-gtid-purged<span class="token operator">=</span>OFF --master-data<span class="token operator">=</span><span class="token number">2</span> --single-transaction<span class="token operator">|</span><span class="token function">gzip</span> <span class="token operator">&gt;</span> /backup/full_<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +%F<span class="token variable">)</span></span>.sql.gz
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></div><!----><footer class="page-meta"><!----><div class="meta-item git-info"><div class="update-time"><span class="label">上次编辑于: </span><!----></div><div class="contributors"><span class="label">贡献者: </span><!--[--><!--[--><span class="contributor" title="email: xinxincn0506@outlook.com">ryanxin7</span><!--]--><!--]--></div></div></footer><nav class="page-nav"><a href="/mysql/log/dba08.html" class="nav-link prev" aria-label="高可用架构方案"><div class="hint"><span class="arrow start"></span>上一页</div><div class="link"><!---->高可用架构方案</div></a><a href="/mysql/log/dba06-2.html" class="nav-link next" aria-label="慢日志分析"><div class="hint">下一页<span class="arrow end"></span></div><div class="link">慢日志分析<!----></div></a></nav><!----><!----><!--]--></main><!--]--><footer class="footer-wrapper"><div class="footer">Ryan's Notebook</div><div class="copyright">Copyright © 2023 Ryan</div></footer></div><!--]--><!----><!----><!--]--></div>
    <script type="module" src="/assets/app-bbc90764.js" defer></script>
  </body>
</html>
